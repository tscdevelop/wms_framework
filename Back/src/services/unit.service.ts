import { Repository, EntityManager, Not, QueryFailedError } from 'typeorm';
import { AppDataSource } from '../config/app-data-source';
import { ApiResponse } from '../models/api-response.model';
import * as lang from '../utils/LangHelper'; // Import LangHelper for specific functions
import * as validate from '../utils/ValidationUtils'; // Import ValidationUtils
import * as genum from '../common/global.enum';

import { m_unit } from '../entities/m_unit.entity';
import { UnitModel } from '../models/unit.model';
import { UnitDropdownModel } from '../models/unit_dropdown.model';
import { deleteEntity } from '../utils/DatabaseUtils';

export class UnitService {
    private unitRepository: Repository<m_unit>;

    constructor(){
        this.unitRepository = AppDataSource.getRepository(m_unit);
    }

    async create(data: Partial<UnitModel>, reqUsername: string, manager?: EntityManager): Promise<ApiResponse<any>> {
        const response = new ApiResponse<UnitModel>();
        const operation = 'UnitService.create';

        const queryRunner = manager ? null : AppDataSource.createQueryRunner();
        const useManager = manager || queryRunner?.manager;

        if (!useManager) {
            return response.setIncomplete(lang.msg('validation.no_entityManager_or_queryRunner_available'));
        }

        if (!manager && queryRunner) {
            await queryRunner.connect();
            await queryRunner.startTransaction();
        }

        try {
            
            const repository = manager ? useManager.getRepository(m_unit) : this.unitRepository;

            if (validate.isNullOrEmpty(data.create_by)) {
                return response.setIncomplete(lang.msgRequiredCreateby());
            }

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏°‡∏≤‡πÉ‡∏ô `data` ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            const existingUnit = await repository
            .createQueryBuilder('unit')
            .where('unit.unit_name_th = :unit_name_th OR unit.unit_name_en = :unit_name_en OR unit.unit_abbr_th = :unit_abbr_th OR unit.unit_abbr_en = :unit_abbr_en', { 
                unit_name_th: data.unit_name_th, 
                unit_name_en: data.unit_name_en,
                unit_abbr_th: data.unit_abbr_th, 
                unit_abbr_en: data.unit_abbr_en })
            .getOne();

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            if (existingUnit) {
                if (existingUnit.unit_name_th === data.unit_name_th) {
                    return response.setIncomplete(lang.msgAlreadyExists('unit.unit_name_th'));
                }
                if (existingUnit.unit_name_en === data.unit_name_en) {
                    return response.setIncomplete(lang.msgAlreadyExists('unit.unit_name_en'));
                }
                if (existingUnit.unit_abbr_th === data.unit_abbr_th) {
                    return response.setIncomplete(lang.msgAlreadyExists('unit.unit_abbr_th'));
                }
                if (existingUnit.unit_abbr_en === data.unit_abbr_en) {
                    return response.setIncomplete(lang.msgAlreadyExists('unit.unit_abbr_en'));
                }
            }
            
            // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            const unitData = repository.create({
                ...data,
                unit_is_active: data.unit_is_active ?? true,
                create_date: new Date(),
                create_by: reqUsername,
            });

            // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å entity (unit) ‡∏•‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            const savedData = await repository.save(unitData);

            // Commit Transaction ‡∏´‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
            if (!manager && queryRunner) {
                await queryRunner.commitTransaction();
            }

            // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• user ‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà
            return response.setComplete(lang.msgSuccessAction('created', 'item.unit'), savedData);

        } catch (error: any) {
            // Rollback ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡∏¥‡∏î Error
            if (!manager && queryRunner) {
                await queryRunner.rollbackTransaction();
            }
            console.error(`Error during ${operation}:`, error);
    
            // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Business Error (Validation, Constraint)
            if (error instanceof QueryFailedError) {
                return response.setIncomplete(lang.msgErrorFunction(operation, error.message));
            }
    
            // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Critical Error (DB ‡∏•‡πà‡∏°, ‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß)
            throw new Error(lang.msgErrorFunction(operation, error.message));
    
        } finally {
            // ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô QueryRunner
            if (!manager && queryRunner) {
                await queryRunner.release();
            }
        }
    }
            
    async update(
        unit_id: number,
        data: Partial<UnitModel>,
        reqUsername: string,
        manager?: EntityManager
    ): Promise<ApiResponse<any>> {
        let response = new ApiResponse<UnitModel>();
        const operation = 'UnitService.update';
    
        const queryRunner = manager ? null : AppDataSource.createQueryRunner();
        const useManager = manager || queryRunner?.manager;
    
        if (!useManager) {
            return response.setIncomplete(lang.msg('validation.no_entityManager_or_queryRunner_available'));
        }
    
        if (!manager && queryRunner) {
            await queryRunner.connect();
            await queryRunner.startTransaction();
        }
    
        try {
            const repository = manager ? useManager.getRepository(m_unit) : this.unitRepository;

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ unit_id ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            const existingUnitId = await repository.findOne({ where: { unit_id: unit_id } });
            if (!existingUnitId) {
                return response.setIncomplete(lang.msgNotFound('unit.unit_id'));
            }
            
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏°‡∏≤‡πÉ‡∏ô `data` ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            const existingUnit = await repository
            .createQueryBuilder('unit')
            .where( '(unit.unit_name_th = :unit_name_th OR unit.unit_name_en = :unit_name_en OR unit.unit_abbr_th = :unit_abbr_th OR unit.unit_abbr_en = :unit_abbr_en) AND unit.unit_id != :unit_id', { 
                unit_name_th: data.unit_name_th, 
                unit_name_en: data.unit_name_en,
                unit_abbr_th: data.unit_abbr_th, 
                unit_abbr_en: data.unit_abbr_en,
                unit_id: unit_id })
            .getOne();

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            if (existingUnit) {
                if (existingUnit.unit_name_th === data.unit_name_th) {
                    return response.setIncomplete(lang.msgAlreadyExists('unit.unit_name_th'));
                }
                if (existingUnit.unit_name_en === data.unit_name_en) {
                    return response.setIncomplete(lang.msgAlreadyExists('unit.unit_name_en'));
                }
                if (existingUnit.unit_abbr_th === data.unit_abbr_th) {
                    return response.setIncomplete(lang.msgAlreadyExists('unit.unit_abbr_th'));
                }
                if (existingUnit.unit_abbr_en === data.unit_abbr_en) {
                    return response.setIncomplete(lang.msgAlreadyExists('unit.unit_abbr_en'));
                }
            }

            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∑‡πà‡∏ô ‡πÜ
            Object.assign(existingUnitId, {
                ...data,
                update_by: reqUsername,
                update_date: new Date(),
            });
    
            await repository.save(existingUnitId); // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    
            // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤
            const dataResponse = await this.getById(unit_id, useManager);
            if (!dataResponse.isCompleted || !dataResponse.data) {
                throw new Error(dataResponse.message);
            }
    
            response = response.setComplete(lang.msgSuccessAction('updated', 'item.unit'), dataResponse.data);
    
            // Commit Transaction ‡∏´‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
            if (!manager && queryRunner) {
                await queryRunner.commitTransaction();
            }

            return response;

        } catch (error: any) {
            // Rollback ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡∏¥‡∏î Error
            if (!manager && queryRunner) {
                await queryRunner.rollbackTransaction();
            }
            console.error(`Error during ${operation}:`, error);
    
            // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Business Error (Validation, Constraint)
            if (error instanceof QueryFailedError) {
                return response.setIncomplete(lang.msgErrorFunction(operation, error.message));
            }
    
            // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Critical Error (DB ‡∏•‡πà‡∏°, ‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß)
            throw new Error(lang.msgErrorFunction(operation, error.message));
    
        } finally {
            // ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô QueryRunner
            if (!manager && queryRunner) {
                await queryRunner.release();
            }
        }
    }

    async delete(unit_id: number, reqUsername: string, manager?: EntityManager): Promise<ApiResponse<void>> {
        const response = new ApiResponse<void>();
        const operation = 'UnitService.delete';
    
        const queryRunner = manager ? null : AppDataSource.createQueryRunner();
        const useManager = manager || queryRunner?.manager;
    
        if (!useManager) {
            return response.setIncomplete(lang.msg('validation.no_entityManager_or_queryRunner_available'));
        }
    
        if (!manager && queryRunner) {
            await queryRunner.connect();
            await queryRunner.startTransaction();
        }
    
        try {
            const repository = manager ? useManager.getRepository(m_unit) : this.unitRepository;

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ unit_id ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            const existingUnit = await repository.findOne({ where: { unit_id: unit_id } });
            if (!existingUnit) {
                return response.setIncomplete(lang.msgNotFound('unit.unit_id'));
            }

            // ‡πÉ‡∏ä‡πâ deleteEntity ‡πÇ‡∏î‡∏¢‡∏™‡πà‡∏á useManager (Transaction)
            const deleteResponse = await deleteEntity(repository, unit_id, reqUsername, 'unit_is_active', 'unit_id');
            
            if (!deleteResponse.isCompleted) {
                return deleteResponse; // ‡∏ñ‡πâ‡∏≤‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÉ‡∏´‡πâ return response ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
            }
            
            // Commit Transaction ‡∏´‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
            if (!manager && queryRunner) {
                await queryRunner.commitTransaction();
            }
    
            // ‡∏™‡πà‡∏á response ‡∏ß‡πà‡∏≤‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
            return response.setComplete(lang.msgSuccessAction('deleted', 'item.unit'));
    
        } catch (error: any) {
            // Rollback ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡∏¥‡∏î Error
            if (!manager && queryRunner) {
                await queryRunner.rollbackTransaction();
            }
            console.error(`Error during ${operation}:`, error);
    
            // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Business Error (Validation, Constraint)
            if (error instanceof QueryFailedError) {
                return response.setIncomplete(lang.msgErrorFunction(operation, error.message));
            }
    
            // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Critical Error (DB ‡∏•‡πà‡∏°, ‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß)
            throw new Error(lang.msgErrorFunction(operation, error.message));
    
        } finally {
            // ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô QueryRunner
            if (!manager && queryRunner) {
                await queryRunner.release();
            }
        }
    }

    async getAll(manager?: EntityManager): Promise<ApiResponse<any | null>> {
        const response = new ApiResponse<any | null>();
        const operation = 'UnitService.getAll';

        try {
            const repository = manager ? manager.getRepository(m_unit) : this.unitRepository;
    
            // Query unit ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö raw data
            const rawData = await repository.createQueryBuilder('unit')
                .select([
                    'unit.unit_id AS unit_id',
                    'unit.unit_name_th AS unit_name_th',
                    'unit.unit_name_en AS unit_name_en',
                    'unit.unit_abbr_th AS unit_abbr_th',
                    'unit.unit_abbr_en AS unit_abbr_en',
                    'unit.create_date AS create_date',
                    'unit.create_by AS create_by',
                    'unit.update_date AS update_date',
                    'unit.update_by AS update_by',
                    'unit.unit_is_active AS unit_is_active'
                ])
                .where('unit.unit_is_active = :isActive', { isActive: true })
                .cache(false) // ‚úÖ ‡∏õ‡∏¥‡∏î Query Cache ‡∏ñ‡πâ‡∏≤ TypeORM ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö
                .getRawMany();

            // ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            if (!rawData || rawData.length === 0) {
                return response.setIncomplete(lang.msgNotFound('item.unit'));
            }

            // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡∏±‡∏ö‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö response
            return response.setComplete(lang.msgFound('item.unit'), rawData);
        } catch (error: any) {
            console.error('Error in getAll:', error);
            if (error instanceof QueryFailedError) {
                return response.setIncomplete(lang.msgErrorFunction(operation, error.message));
            }
    
            throw new Error(lang.msgErrorFunction(operation, error.message));
        }
    }
    
    async getById(unit_id: number, manager?: EntityManager): Promise<ApiResponse<any | null>> {
        const response = new ApiResponse<any | null>();
        const operation = 'UnitService.getById';

        try {
            const repository = manager ? manager.getRepository(m_unit) : this.unitRepository;
    
            // Query unit ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö raw data
            const rawData = await repository.createQueryBuilder('unit')
                .select([
                    'unit.unit_id AS unit_id',
                    'unit.unit_name_th AS unit_name_th',
                    'unit.unit_name_en AS unit_name_en',
                    'unit.unit_abbr_th AS unit_abbr_th',
                    'unit.unit_abbr_en AS unit_abbr_en',
                    'unit.create_date AS create_date',
                    'unit.create_by AS create_by',
                    'unit.update_date AS update_date',
                    'unit.update_by AS update_by',
                    'unit.unit_is_active AS unit_is_active'
                ])
                .where('unit.unit_id = :unit_id', { unit_id })
                .andWhere('unit.unit_is_active = :isActive', { isActive: true })
                .getRawOne();

            // ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            if (!rawData || rawData.length === 0) {
                return response.setIncomplete(lang.msgNotFound('unit.unit_id'));
            }

            // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡∏±‡∏ö‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö response
            return response.setComplete(lang.msgFound('unit.unit_id'), rawData);
        } catch (error: any) {
            console.error(`Error in ${operation} with unit_id: ${unit_id}`, error);
            if (error instanceof QueryFailedError) {
                return response.setIncomplete(lang.msgErrorFunction(operation, error.message));
            }
    
            throw new Error(lang.msgErrorFunction(operation, error.message));
        }
    }

    async getUnitDropdown(language:string, manager?: EntityManager): Promise<ApiResponse<any>> {
        let response = new ApiResponse<any>();
        const operation = 'UnitService.getUnitDropdown';
    
        if (!language) {
            return response.setIncomplete(lang.msgInvalidParameter());
        }

        try {
            const repository = manager ? manager.getRepository(m_unit) : this.unitRepository;
            // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á unit_id ‡πÅ‡∏•‡∏∞ unit_abbr_th
            const rawData = await repository.createQueryBuilder("unit")
                .select([
                    "unit.unit_id AS unit_id", 
                    "unit.unit_abbr_th AS unit_abbr_th",
                    "unit.unit_abbr_en AS unit_abbr_en"
                ])
                .where("unit.unit_abbr_th IS NOT NULL AND unit.unit_abbr_en IS NOT NULL") // ‡∏Å‡∏£‡∏≠‡∏á‡∏Ñ‡πà‡∏≤ null ‡∏≠‡∏≠‡∏Å
                .andWhere('unit.unit_is_active = :isActive', { isActive: true })
                .distinct(true) // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô
                .getRawMany();
    
            if (!rawData || rawData.length === 0) {
                return response.setIncomplete(lang.msgNotFound('item.unit'));
            }
    
            console.log('rawData:', rawData); // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏î‡∏∂‡∏á‡∏°‡∏≤
    
            // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ú‡∏ô‡∏Å‡∏ï‡∏≤‡∏°‡∏†‡∏≤‡∏©‡∏≤‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏°‡∏≤
            // const data = rawData.map((unit: any) => {
            //     const text = language === genum.Language.TH ? unit.unit_abbr_th : unit.unit_abbr_en;
            //     return new UnitDropdownModel(unit.unit_id, text);
            // });
            // ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö UnitDropdownModel
            const data = rawData.map((unit) => new UnitDropdownModel(unit.unit_id,unit.unit_abbr_th));

            return response.setComplete(lang.msgFound('item.unit'), data);
    
        } catch (error: any) {
            console.error('Error during getUnitDropdown:', error.message);
            if (error instanceof QueryFailedError) {
                return response.setIncomplete(lang.msgErrorFunction(operation, error.message));
            }
    
            throw new Error(lang.msgErrorFunction(operation, error.message));
        }
    }

    async createJson(
        data: any[], 
        reqUsername: string, 
        manager?: EntityManager
    ): Promise<ApiResponse<any>> {
        const response = new ApiResponse<any>();
        const operation = 'UnitService.createJson';
    
        // ‚úÖ ‡πÉ‡∏ä‡πâ `QueryRunner` ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Transaction
        const queryRunner = manager ? null : AppDataSource.createQueryRunner();
        const useManager = manager || queryRunner?.manager;
        if (!useManager) {
            return response.setIncomplete(lang.msg('validation.no_entityManager_or_queryRunner_available'));
        }
    
        if (!manager && queryRunner) {
            await queryRunner.connect();
            await queryRunner.startTransaction();
        }
    
        try {
            const repository = useManager.getRepository(m_unit);
    
            // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            if (!data || !Array.isArray(data) || data.length === 0) {
                return response.setIncomplete(lang.msgDataNotFound());
            }
    
            // ‚úÖ Map ‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏à‡∏≤‡∏Å JSON ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ü‡∏¥‡∏•‡∏î‡πå‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            const fieldMapping: Record<string, keyof m_unit> = {
                '‡∏´‡∏ô‡πà‡∏ß‡∏¢': 'unit_name_th',
                '‡∏´‡∏ô‡πà‡∏ß‡∏¢(‡∏Ñ‡∏≥‡∏¢‡πà‡∏≠)': 'unit_abbr_th',
                'Unit': 'unit_name_en',
                'Unit(Abbreviation)': 'unit_abbr_en'
            };
    
            console.log('üìå Raw JSON Data:', data);
    
            // ‚úÖ ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            const formattedData: Partial<m_unit>[] = data.map((row: any, index) => {
                const mappedRow: Partial<m_unit> = {};
    
                Object.keys(row).forEach((jsonKey) => {
                    const dbField = fieldMapping[jsonKey];
                    if (dbField) {
                        mappedRow[dbField] = row[jsonKey] !== '' ? row[jsonKey] : null; // ‚úÖ ‡πÉ‡∏´‡πâ `""` ‡πÄ‡∏õ‡πá‡∏ô `null`
                    }
                });
    
                // ‚úÖ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ default values
                mappedRow.unit_is_active = mappedRow.unit_is_active ?? true;
                mappedRow.create_date = new Date();
                mappedRow.create_by = reqUsername;
    
                console.log(`üìå Mapped Row ${index + 1}:`, mappedRow);
                return mappedRow;
            });
    
            console.log("formattedData",formattedData)
            // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
            for (const item of formattedData) {
                if (validate.isNullOrEmpty(item.unit_name_th)) {
                    return response.setIncomplete(lang.msgRequired('unit.unit_name_th'));
                }
                if (validate.isNullOrEmpty(item.unit_abbr_th)) {
                    return response.setIncomplete(lang.msgRequired('unit.unit_abbr_th'));
                }
                if (validate.isNullOrEmpty(item.unit_name_en)) {
                    return response.setIncomplete(lang.msgRequired('unit.unit_name_en'));
                }
                if (validate.isNullOrEmpty(item.unit_abbr_en)) {
                    return response.setIncomplete(lang.msgRequired('unit.unit_abbr_en'));
                }
            }

    /* ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô‡πÄ‡∏≠‡∏á‡πÉ‡∏ô excel */
            // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô‡πÄ‡∏≠‡∏á‡πÉ‡∏ô Excel (‡∏ñ‡πâ‡∏≤ field ‡πÉ‡∏î field ‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏ã‡πâ‡∏≥ ‡∏Å‡πá‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏ã‡πâ‡∏≥)
            const seenUnits = new Set<string>();
            const duplicateEntries: Partial<m_unit>[] = [];

            formattedData.forEach((s) => {
                const keys = [
                    s.unit_name_th?.trim(),
                    s.unit_abbr_th?.trim(),
                    s.unit_name_en?.trim(),
                    s.unit_abbr_en?.trim()
                ];

                // ‡∏ï‡∏£‡∏ß‡∏à‡∏ß‡πà‡∏≤‡∏ü‡∏¥‡∏•‡∏î‡πå‡πÉ‡∏î‡∏ã‡πâ‡∏≥‡∏ö‡πâ‡∏≤‡∏á
                const isDuplicate = keys.some(key => seenUnits.has(key || ''));

                if (isDuplicate) {
                    duplicateEntries.push(s);
                }

                keys.forEach(key => {
                    if (key) seenUnits.add(key);
                });
            });

            if (duplicateEntries.length > 0) {
                return response.setIncomplete(
                    `‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô‡πÄ‡∏≠‡∏á‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå ${duplicateEntries.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£: ` +
                    duplicateEntries.map(e => `${e.unit_name_th} (${e.unit_abbr_th})`).join(', ')
                );
            }
            
            // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô‡πÄ‡∏≠‡∏á ‡∏Å‡πá‡πÉ‡∏ä‡πâ formattedData ‡πÄ‡∏õ‡πá‡∏ô uniqueUnits
            const uniqueUnits = formattedData;

    /* ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö */
            // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ö‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏ñ‡πâ‡∏≤ field ‡πÉ‡∏î field ‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏ã‡πâ‡∏≥ ‡∏Å‡πá‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏ã‡πâ‡∏≥)
            const existingUnits = await repository
                .createQueryBuilder('unit')
                .where('unit.unit_name_th IN (:...nameTh) OR unit.unit_abbr_th IN (:...abbrTh) OR unit.unit_name_en IN (:...nameEn) OR unit.unit_abbr_en IN (:...abbrEn)', {
                    nameTh: formattedData.map(s => s.unit_name_th).filter(Boolean),
                    abbrTh: formattedData.map(s => s.unit_abbr_th).filter(Boolean),
                    nameEn: formattedData.map(s => s.unit_name_en).filter(Boolean),
                    abbrEn: formattedData.map(s => s.unit_abbr_en).filter(Boolean)
                })
                .getMany();

            const duplicateInInput = formattedData.filter((s) =>
                existingUnits.some((ex) =>
                    ex.unit_name_th === s.unit_name_th ||
                    ex.unit_abbr_th === s.unit_abbr_th ||
                    ex.unit_name_en === s.unit_name_en ||
                    ex.unit_abbr_en === s.unit_abbr_en
                )
            );

            if (duplicateInInput.length > 0) {
                return response.setIncomplete(
                    `‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ${duplicateInInput.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£: ` +
                    duplicateInInput.map(e => `${e.unit_name_th} (${e.unit_abbr_th})`).join(', ')
                );
            }

            // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡πâ‡∏≥‡πÄ‡∏•‡∏¢ ‡∏Å‡πá‡∏ó‡∏≥‡∏Å‡∏≤‡∏£ save
            const savedUnit = await repository.save(uniqueUnits);
    
            // ‚úÖ Commit Transaction
            if (!manager && queryRunner) {
                await queryRunner.commitTransaction();
            }
    
            return response.setComplete(lang.msgSuccessAction('created', 'item.unit'), savedUnit);
    
        } catch (error: any) {
            if (!manager && queryRunner) {
                await queryRunner.rollbackTransaction();
            }
            console.error(`‚ùå Error in ${operation}:`, error);
            return response.setIncomplete(lang.msgErrorFunction(operation, error.message));
        } finally {
            if (!manager && queryRunner) {
                await queryRunner.release();
            }
        }
    }
}